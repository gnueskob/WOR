# 메모

## 기획 데이터

- Q&A : https://docs.google.com/spreadsheets/d/1usynExUehjaw7gWuFvIVMUn0KRNqEP-VrDcDtMGIxlM/edit#gid=0
- dataset : https://docs.google.com/spreadsheets/d/12bSNwPvp6o7ach5bYJQcT1rvx6-xl12krhYxsjc-at4/edit#gid=0

## 토큰 검증

- 하이브 uid, 유저 영토 id를 이용하여 JWT 생성
- 클라는 JWT를 HTTP 헤더에 추가하여 요청
- 서버는 JWT 검증시 `user`테이블에 저장된 내용과 일치하는지 검사
- 유저에 대한 영토 정보는 토큰에 포함된 영토 id를 이용해 memcached 접근

## 기획 데이터 - 구글 스프레드 시트

- 다른 테이블의 데이터 참조 시 id, name 전부 parsing
- 다른 시트의 index Vlookup 함수로 참조
- 기준을 사람이 보기 쉬운 문자열 값으로 설정

## 유저 데이터

- 유저 데이터 로딩은 초기 게임 접속시에 한꺼번에 처리
- 각 데이터의 갱신은 서버로 요청과 함께 갱신된 값을 반환받음

## 단위 시간당 자원 생산량

1. 폴링을 통한 개인별 자원 갱신 (주기적 정산)
   - 유저가 게임에 접속중일 경우 폴링을 통해 단위시간당 자원 업데이트 요청을 보냄
   - 클라에서 자원 획득을 확인할 수 있으며 요청이 더이상 가지 않을 경우 게임 종류(혹은 게임 접속 불량)으로 판단
   - 다시 게임에 접속할 시 마지막으로 자원 생산 요청을 보냈던 시점을 기준으로 접속 시간 동안의 자원 생산량 계산후 갱신
   - 문제점 : 클라 -> 서버 -> DB 데이터 획득 -> 값 계산 -> DB 갱신 -> 서버 -> 클라 순으로 요청 처리

2. 서버측의 단위시간으로 모든 유저대상으로 매 주기별 갱신
   - 클라이언트 측과 상관없이 오로지 서버측에서 단위시간을 계산하고 주기적으로 모든 유저의 조건에 맞는 자원 수량을 갱신
     - 클라 -> 서버 -> DB 데이터 획득 -> 클라 순으로 요청 처리 (DB가 항상 갱신된 값을 들고있기 때문)
     - 서버 부하가 크지 않을까?
   - 클라이언트는 서버의 주기와 맞춰 갱신된 데이터만 확인하는 방식

## 테이블 PK 설정 관련

- 새로운 유저가 들어오고 해당 유저가 자원, 건물등을 지을 때 유저별로 클러스터링 되는것이 좋겠지만  
  유저 ID 순서별로 자원을 발견하거나 건물을 생성하지 않으므로 레코드의 재분배가 매우 심하게 일어날 것

- 재분배의 이슈를 해결하기 위해서는 AUTO_INC를 사용하거나, 애초에 유저가 다룰 수 있는 모든 경우를 레코드로 함께 추가시켜 놓는 것
- 자원의 경우는 위의 방안이 가능하나(기획데이터로 고정이기 때문), 건축물의 경우는 유저데이터이므로 불가

## 선전포고 당한 유저 처리

- 다른 유저로부터 선전포고를 당한 유저는 이를 알 필요가 있음
  1. 게임 중 - 폴링을 통해서 주기적으로 보내는 요청에 전쟁 여부를 검사하는 로직을 추가하는 방법
     - [전쟁 패배 시] 게임 진행 중 패널티를 부여받게 됨 (특정 시간동안 자원 채취 건물 정지)
  2. 접속 종료 상태 - 다음 게임 접속 후 서버로 보내는 요청에 검사 로직을 추가
     - [전쟁 패배 시] 접속 종료 기간동안 얻을 수 있는 자원에서 약탈 비율만큼 자원 획득량이 감소함

## 로그 처럼 쌓여가는 데이터들은 어떻게 처리해야 하는가

- 전쟁(선전포고) 같은 경우 history를 남겨가며 각 선전포고를 독립적으로 계속 데이터에 추가해나갈 것인가?
  - 만료 시간을 정해서 이전 정보들은 따로 저장해두기
- 유저-유저 정보를 키값으로 하여 재사용하여 유한한 데이터를 유지할 것인가?
  - 이전 히스토리를 확인할 수 없음

## 게임 Flow

1. [로비 화면] 게임 접속 시 로그인 / 회원가입
2. [유저 영내 화면] 접속 성공

   - 기본 정보
     - 유저의 스펙 정보
       - 인구 (가용인구, 총인구)
       - 공격력
       - 방어력
       - 충성도
       - 자원
     - 유저 영내에서 탐사된 타일, 탐사되지 않은 타일
     - 탐사된 타일에 존재하는 자원 혹은 건물들
   - 유저의 건물 정보
   - 유저의 무기 정보
   - 유저의 동맹 정보
   - 유저의 전쟁(선전포고) 정보
   - 유저의 전쟁(다른 유저로부터) 정보

3. 영내 탐사

   - 유저가 아직 탐사하지 않은 타일을 선택하여 탐사 요청
   - 특정 단위시간 후 해당 타일은 탐사된 타일로 변환 (from 서버)

4. 건물 생성

   - 특정 타일에 조건에 맞는 건물을 생성
   - 건물 생성 요청 - 건물에 해당하는 자원, 인구 수 검사 후 소모
   - 특정 단위시간 후 해당 타일에 건물이 생성됨 (from 서버)

5. 건물 업그레이드

   - 건물 업그레이드 요청 - 업그레이드에 필요한 자원 수량 검사 후 소모
   - 특정 단위시간 후 해당 건물 업그레이드 완료 (from 서버)

6. 건물 삭제

   - 건물 삭제 요청 - 이미 존재하는 건물인지 검사 후 건물 삭제
   - 특정 단위 시간 후 건물 삭제 완료 (from 서버)

7. 건물 인구 배치

   - 건물 인구 배치 요청 - 이미 존재하는 건물인지, 이미 인구가 배치된 건물인지 검사 후 인구 배치
   - 특정 단위 시간 후 배치 완료 (from 서버)

8. 건물 인구 배치 취소

   - 건물 인구 배치 취소 요청 - 이미 존재하는 건물인지, 이미 인구가 배치된 건물인지 검사 후 인구 배치 취소
   - 요청 후 바로 건물의 인력은 가용 인구로 변환

9. 각 건물 기능

   - 성
     - 인구 자동 생산 기능
     - 토글 형식으로 인구 자동 생산을 On / Off 할 수 있음

   - 방어탑
     - 영토 방어력 소폭 증가

   - 병영
     - 인력 배치를 통해 영토의 공격력 상승

   - 곡창, 공장
     - 식량자원, 전략자원 상승

   - 공방
     - 성 업그레이드
       - 성 업그레이드 요청 - 자원 수량 검사 후 성의 업그레이드 단계 증가
       - 특정 단위 시간 후 업그레이드 완료 (from 서버)
     - 무기 생산
       - 무기 생산 요청 - 자원 수량 검사 후 무기 생산
       - 특정 단위 시간 후 무기 사용 가능 (from 서버)
     - 무기 업그레이드
       - 무기 업그레이드 요청 - 자원 수량 검사 후 무기 업그레이드 단계 증가
       - 특정 단위 시간 후 업그레이드 완료 (from 서버)

10. 사치자원을 이용한 버프

    - 사치자원 충성도 버프 요청 - 인구 수에 맞는 사치자원 보유량 검사 후 충성도 버프 적용
    - 특정 단위 시간동안 버프 지속

11. [영토 화면 (맵 전체)]

    - 현재 유저가 탐사하여 알고있는 영토 정보

12. 영토 탐사

    - 아직 탐사하지 않은 영토를 탐사
    - 특정 위치 좌표를 통해 해당 영토로 탐사 요청
    - 거리에 비례한 단위시간 후 영토 탐사 완료 (from 서버)

13. 선전포고

    - 이미 탐사된 영토로 선전포고 요청 - 해당 영토가 탐사되었는지, 이미 선전포고 중인지 검사 후 선전포고 준비
    - 특정 단위시간 후 전쟁 시뮬레이션, 결과 저장

14. 동맹 요청

    - 이미 탐사된 영토로 동맹 요청 - 해당 영토가 탐사 되었는지, 이미 동맹 요청이 보내진 상태인지 검사 후 동맹 요청 보냄
    - 상대방에게 동맹 요청 알림
    - 상대방이 동맹 요청 수락 시 서로 영토가 탐사된 상태로 변환

15. 동맹 거절

    - 동맹 요청을 받은 유저는 동맹 요청을 거절 할 수 있음
    - <추가> 동맹 거절시 영구적으로 동맹 요청한 유저와 동맹을 할 수 없게 됨

16. 동맹 영토 자원 공유

    - 동맹을 맺은 영토에게는 일부 자원들을 보내주고 받을 수 있음
    - 해당 영토(유저)에게 자원 보내기 요청 - 자신의 자원이 충분한지, 동맹을 맺은 유저인지, 확인 후 자원 보내기 요청
    - 자원을 공유받은 유저는 우편함에 쌓이는 식으로 구현
    - 해당 유저가 받기 요청을 보내면 해당 유저의 자원에 추가 됨

17. 레이드

    - 특수 지역에 보스가 존재할 경우 동맹 유저들이 레이드에 도전할 수 있음
    - 동맹 그룹 중의 한 유저가 보스 레이드를 신청하면 해당 보스는 특정 시간동안 전투모드에 돌입
    - 전투모드에 돌입된 보스의 체력게이지는 동맹한 유저들 모두가 공유
    - 해당 보스에게로의 출전을 통해 보스 체력 게이지를 소모시킬 수 있음
    - 체력을 모두 소모시키면 해당 보스는 처치되고 동맹 유저들은 전리품을 획득하고 해당 영토의 점령자가 됨
    - 점령자가 되면 특정 기간동안 보스에 따라서 버프효과를 받음
    - 그 동안 다른 동맹국이 해당 영토로 선전포고하여 점령지를 탈환할 수 있음
      - 일반 유저vs유저 전쟁과 비슷하지만 동맹국 전체 합산 스탯과 동일한 체력을 가진 보스 전투와 동일하게 처리되며
      - 점령지 탈환 성공시 기존에 버프 효과가 존재할 경우 남은 기간동안 버프효과를 해당 동맹 유저들이 받을 수 있음